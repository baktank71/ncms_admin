<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cr.cntnts">

	<resultMap id="getList" type="egovMap">
		<result property="CONTENTS" column="CONTENTS"  jdbcType="CLOB" javaType="java.lang.String" />
	</resultMap>	
	
  <!-- 컨텐츠 목록 조회 -->
  <select id="list"  parameterType="egovMap" resultMap="getList">
	    SELECT *
		FROM (		
			SELECT ROWNUM AS RNUM 
			  	 , aa.*
			FROM (
				SELECT CONTENTS_ID
					 , DIVISION_CODE
					 , COUNT(*) OVER() AS TOTAL_COUNT
					 , TITLE
					 , CONTENTS
					 , WRITE_USER_ID
					 , WRITE_NAME
					 , JBSOURCE
					 , READ_COUNT
					 , IS_OPEN
					 , TO_CHAR(TO_DATE(WRITE_TIME,'yyyymmddhhmiss'),'yyyy-mm-dd') AS write_time
					 , TO_CHAR(TO_DATE(LAST_MODIFIED,'yyyymmddhhmiss'),'yyyy-mm-dd') AS last_modified 
					 , (SELECT COUNT(contents_id) FROM contents_info_file WHERE contents_id = a.contents_id ) AS file_count
				FROM CONTENTS_INFO a
				WHERE 1=1
				<if test ='divisionCode != null and divisionCode != ""'>
					AND DIVISION_CODE = #{divisionCode}
				</if>
				<!-- 검색 쿼리 -->
				<if test = 'searchStr != null and searchStr != ""'>
					<choose>
						<when test = 'searchId == "1"'>
							AND TITLE LIKE '%' || UPPER(#{searchStr }) || '%'
						</when>
						<when test = 'searchId == "2"'>
							AND SUBSTR(CONTENTS, 0, LENGTH(CONTENTS)) LIKE '%' || UPPER(#{searchStr }) || '%'
						</when>
						<otherwise>
							AND (TITLE LIKE '%' || UPPER(#{searchStr }) || '%'
							OR SUBSTR(CONTENTS, 0, LENGTH(CONTENTS)) LIKE '%' || UPPER(#{searchStr }) || '%')
						</otherwise>
					</choose>
				</if>
				<if test = 'searchFromDate != null and searchFromDate != ""'>
					AND TO_DATE(SUBSTR(WRITE_TIME,1,8), 'yyyymmdd') <![CDATA[>=]]> TO_DATE(REPLACE(#{searchFromDate}, '-',''), 'yyyymmdd')
				</if>
				<if test ='searchToDate != null and searchToDate != ""'>
					AND TO_DATE(SUBSTR(WRITE_TIME,1,8), 'yyyymmdd') <![CDATA[<=]]> TO_DATE(REPLACE(#{searchToDate}, '-',''), 'yyyymmdd')
				</if>
				<if test= 'searchOpenYn != null and searchOpenYn != ""'>
					AND IS_OPEN = #{searchOpenYn }
				</if>
				ORDER BY CONTENTS_ID DESC
				) AS aa
			)
		WHERE 
			RNUM BETWEEN #{START} AND #{END}
	</select>
	
	<!-- 컨텐츠 상세보기 -->
	<select id="detail" parameterType="egovMap" resultMap="getList">
		SELECT 	CONTENTS_ID
			,	DIVISION_CODE
			,	TITLE
			,	TITLE_DC
			,	CONTENTS
			,	WRITE_USER_ID
			,	WRITE_NAME
			,	IS_OPEN
			,	JBSOURCE
			,	TO_CHAR(TO_DATE(WRITE_TIME, 'yyyymmddhhmiss'), 'yyyy-mm-dd') AS write_time
			,	TO_CHAR(TO_DATE(LAST_MODIFIED, 'yyyymmddhhmiss'), 'yyyy-mm-dd') AS last_modified
		FROM	CONTENTS_INFO
		WHERE	CONTENTS_ID = #{contentsId}
	</select>
	
	<!-- 컨텐츠 상세보기 파일 리스트 -->
	<select id="detailFile" parameterType="String" resultType="egovMap">
		SELECT 	FILE_ID
			,	ATTACHMENT
			,	ATTACHMENT_ORIGINAL
			,	SERVER_PATH
		FROM CONTENTS_INFO_FILE
		WHERE CONTENTS_ID = #{contentsId }
	</select>
	
	<!-- 컨텐츠 공유/비공유 여부 수정 -->
	<update id="updateOpenYn" parameterType="egovMap">
		UPDATE CONTENTS_INFO
		SET IS_OPEN = #{isOpen }
		WHERE CONTENTS_ID IN
 		<foreach collection="contentsIdList" item="item" index="index" separator="," open="(" close=")" >
            #{item, jdbcType=VARCHAR}
 		</foreach>
	</update>

	<!-- 컨텐츠 등록 -->
	<insert id="insert" parameterType="egovMap">
		<selectKey keyProperty="contentsIdIndex" resultType="String" order="BEFORE">
			SELECT SQ_CONTENTSID_INDEX.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO CONTENTS_INFO (
			CONTENTS_ID,
			DIVISION_CODE,
			JBSOURCE,
			TITLE,
			TITLE_DC,
			CONTENTS,
			WRITE_NAME,
			WRITE_TIME,
			READ_COUNT,
			IS_OPEN,
			WRITE_USER_ID
		)
		VALUES (
			#{contentsIdIndex },
			#{divisionCode },
			#{jbsource },
			#{title },
			#{titleDc },
			#{contents },
			#{userNm },
			TO_CHAR(SYSDATE, 'YYYYMMDDhhmiss'),
			0,
			#{isOpen },
			#{userId }
		)
	</insert>
	
	<!-- 컨텐츠 수정 -->
	<update id="update" parameterType="egovMap">
		UPDATE 
			CONTENTS_INFO
		SET 
			JBSOURCE = #{jbsource},
			IS_OPEN = #{isOpen },
			TITLE = #{title },
			TITLE_DC = #{titleDc },
			CONTENTS = #{contents },
			LAST_MODIFIED = TO_CHAR(SYSDATE, 'YYYYMMDDhhmiss')
		WHERE 
			CONTENTS_ID = #{contentsId }
	</update>

	<!-- 컨텐츠 삭제 -->	
	<delete id="delete" parameterType="egovMap">
		DELETE FROM CONTENTS_INFO
		WHERE CONTENTS_ID = #{contentsId }
	</delete>
	
</mapper>