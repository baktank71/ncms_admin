<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mp.ntt">

	<resultMap id="getList" type="egovMap">
		<result property="CONTENTS" column="CONTENTS"  jdbcType="CLOB" javaType="java.lang.String" />
	</resultMap>	
	
  	<!-- 게시글 목록 조회 -->
	<select id="list" parameterType="egovMap" resultMap="getList">
	
		SELECT * FROM (
			SELECT ROWNUM AS RNUM,
			aa.*
			FROM (
				SELECT CONTENTS_ID
					 , DIVISION_CODE
					 , COUNT(*) OVER() AS TOTAL_COUNT
					 , TITLE
					 , CONTENTS
					 , WRITE_USER_ID
					 , WRITE_NAME
					 , JBSOURCE
					 , IS_OPEN
					 , TO_CHAR(TO_DATE(WRITE_TIME,'yyyymmddhhmiss'),'yyyy-mm-dd') AS write_time
					 , TO_CHAR(TO_DATE(LAST_MODIFIED,'yyyymmddhhmiss'),'yyyy-mm-dd') AS last_modified 
					 , (SELECT COUNT(contents_id) FROM contents_info_file WHERE contents_id = a.contents_id ) AS file_count
				FROM CONTENTS_INFO a
				<if test = 'divisionCode != null and divisionCode != ""'>
				WHERE 1=1
					<choose>
						<when test = 'divisionCode == "0331"'>
							<choose>
								<when test = 'faqId == "A"'>
									AND DIVISION_CODE = 0331
								</when>
								<when test = 'faqId == "B"'>
									AND DIVISION_CODE = 0333
								</when>
								<otherwise>
									AND DIVISION_CODE IN(0331,0333)
								</otherwise>
							</choose>
						</when>					
						<otherwise>
							AND DIVISION_CODE = #{divisionCode }
						</otherwise>
					</choose>
				</if>
				
				<if test = 'searchStr != null and searchStr != ""'>
					<choose>
						<when test = 'searchId == "1"'>
							AND TITLE LIKE '%' || #{searchStr } || '%'
						</when>
						<when test = 'searchId == "2"'>
							AND SUBSTR(CONTENTS, 0, LENGTH(CONTENTS)) LIKE '%' || #{searchStr } || '%'
						</when>
						<otherwise>
							AND (TITLE LIKE '%' || UPPER(#{searchStr }) || '%'
							OR SUBSTR(CONTENTS, 0, LENGTH(CONTENTS)) LIKE '%' || #{searchStr } || '%')
						</otherwise>
					</choose>
				</if>
				
				<if test = 'searchFromDate != null and searchFromDate != ""'>
					AND TO_DATE(SUBSTR(WRITE_TIME,1,8), 'yyyymmdd') <![CDATA[>=]]> TO_DATE(REPLACE(#{searchFromDate}, '-',''), 'yyyymmdd')
				</if>
				<if test = 'searchToDate != null and searchToDate != ""'>
					AND TO_DATE(SUBSTR(WRITE_TIME,1,8), 'yyyymmdd') <![CDATA[<=]]> TO_DATE(REPLACE(#{searchToDate}, '-',''), 'yyyymmdd')
				</if>
				ORDER BY CONTENTS_ID DESC, WRITE_TIME DESC
			) AS aa
		)
		WHERE 1=1
		AND RNUM BETWEEN #{START } AND #{END }
	</select>
	
	<!-- 게시판 상세보기 -->
	<select id="detail" parameterType="egovMap" resultMap="getList">
		SELECT	CONTENTS_ID,
				DIVISION_CODE,
				TITLE,
				CONTENTS,
				WRITE_USER_ID,
				WRITE_NAME,
				JBSOURCE,
				READ_COUNT,
				IS_OPEN,
				TO_CHAR(TO_DATE(WRITE_TIME, 'yyyymmddhhmiss'), 'yyyy-mm-dd') AS write_time,
				TO_CHAR(TO_DATE(LAST_MODIFIED, 'yyyymmddhhmiss'), 'yyyy-mm-dd') AS last_modified
		FROM	CONTENTS_INFO
		WHERE	CONTENTS_ID = #{contentsId }
		AND		DIVISION_CODE = #{divisionCode }	
	</select>
	
	<!-- 상세보기 할 시, 해당 게시판에 첨부파일이 있을 때 보여주는 쿼리 -->
	<select id="detailFile" parameterType="String" resultType="egovMap">
		SELECT 	FILE_ID,
				ATTACHMENT,
				ATTACHMENT_ORIGINAL,
				SERVER_PATH
		FROM	CONTENTS_INFO_FILE
		WHERE	CONTENTS_ID = #{contentsId }
	</select>
	
	<!-- 이전글 다음글 -->
	<select id="preNext" parameterType="egovMap" resultMap="getList">
		SELECT
			a.CONTENTS_ID, a.TITLE
		FROM
			CONTENTS_INFO a,
		( SELECT 
			<if test='preNext == "pre"'>
				MIN(CONTENTS_ID) as CONTENTS_ID
			</if>
			<if test='preNext == "next"'>
				MAX(CONTENTS_ID) as CONTENTS_ID
			</if>
		FROM CONTENTS_INFO
		WHERE DIVISION_CODE = #{divisionCode }
<!-- 		<if test='divisionCode != null and divisionCode != ""'> -->
<!-- 			AND DIVISION_CODE = #{divisionCode } -->
<!-- 		</if> -->
		<if test = 'searchStr != null and searchStr != ""'>
			<choose>
				<when test='searchId == "1"'>
					AND UPPER(title) LIKE '%' || UPPER(#{searchStr}) || '%'
				</when>
				<when test='searchId == "2"'>
					AND SUBSTR(contents, 0, LENGTH(contents)) LIKE '%' || #{searchStr } || '%'
				</when>
				<otherwise>
					AND (UPPER(title) LIKE '%' || UPPER(#{searchStr }) || '%'
					OR SUBSTR(contents, 0, LENGTH(contents)) LIKE '%' || #{searchStr } || '%')
				</otherwise>
			</choose>
		</if>

		<!-- 검색 했음과 안했음와의 차이 -->
		<if test = 'searchFromDate != null and searchFromDate != ""'>
				AND TO_DATE(SUBSTR(WRITE_TIME,1,8), 'yyyymmdd') <![CDATA[>=]]> TO_DATE(REPLACE(#{searchFromDate}, '-',''), 'yyyymmdd')
		</if>
		<if test ='searchToDate != null and searchToDate != ""'>
				AND TO_DATE(SUBSTR(WRITE_TIME,1,8), 'yyyymmdd') <![CDATA[<=]]> TO_DATE(REPLACE(#{searchToDate}, '-',''), 'yyyymmdd')
		</if>
		
		<if test='preNext == "pre"'>
			AND CONTENTS_ID <![CDATA[ > ]]> #{contentsId }
		</if>
		
		<if test='preNext == "next"'>
			AND CONTENTS_ID <![CDATA[ < ]]> #{contentsId }
		</if>
		) b
		WHERE a.CONTENTS_ID = b.CONTENTS_ID
	</select>

	<!-- 공개, 비공개 버튼 누를시 수정하는 쿼리문 -->
	<update id="updateOpenYn" parameterType="egovMap">
		UPDATE CONTENTS_INFO
		SET IS_OPEN = #{isOpen }
		WHERE CONTENTS_ID IN
		<foreach collection="contentsIdList" item="item" index="index" separator="," open="(" close=")">
			#{item, jdbcType=VARCHAR}
		</foreach>
	</update>
	
	<!-- 게시글 수정하기 -->
	<update id="update" parameterType="egovMap">
		UPDATE CONTENTS_INFO
		SET 
			DIVISION_CODE = #{divisionCode },
			IS_OPEN = #{isOpen },
			TITLE = #{title },
			CONTENTS = #{contents },
			LAST_MODIFIED = TO_CHAR(SYSDATE, 'YYYYMMDDhhmiss')
		WHERE 1=1
		AND CONTENTS_ID = #{contentsId }
	</update>
	
	<!-- 게시글 등록하기 -->
	<insert id="insert" parameterType="egovMap">
		<selectKey keyProperty="contentsIdIndex" resultType="integer" order="AFTER">
			SELECT SQ_CONTENTSID_INDEX.CURRVAL FROM DUAL
		</selectKey>
		INSERT INTO CONTENTS_INFO (
			CONTENTS_ID,
			DIVISION_CODE,
			TITLE,
			CONTENTS,
			WRITE_NAME,
			WRITE_TIME,
			READ_COUNT,
			IS_OPEN,
			JBSOURCE,
			WRITE_USER_ID
		)
		VALUES (
			SQ_CONTENTSID_INDEX.NEXTVAL,
			#{divisionCode },
			#{title },
			#{contents },
			#{userNm },
			TO_CHAR(SYSDATE, 'YYYYMMDDhhmiss'),
			0,
			#{isOpen },
			#{jbsource },
			#{userId }
		)
	</insert>
	
	
	<!-- 게시글 삭제하기 -->
	<delete id="delete"	parameterType="egovMap">
		DELETE FROM CONTENTS_INFO
		WHERE 1=1
		AND CONTENTS_ID = #{contentsId }
	</delete>
</mapper>